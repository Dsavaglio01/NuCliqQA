{"version":3,"sources":["Blur.tsx"],"names":["vertShader","fragShader","Blur","setProcessing","processingState","imageData","setImageData","imageDataState","setEditingMode","editingModeState","glContext","setGLContext","glContextState","imageBounds","imageBoundsState","throttleBlur","React","useContext","EditorContext","sliderValue","setSliderValue","useState","blur","setBlur","glProgram","setGLProgram","onClose","onSaveWithBlur","gl","drawArrays","TRIANGLES","output","GLView","takeSnapshotAsync","Platform","OS","fileReaderInstance","FileReader","readAsDataURL","uri","onload","base64data","result","flippedOutput","ImageManinpulator","manipulateAsync","flip","FlipType","Vertical","width","height","setTimeout","useEffect","setupGL","asset","localUri","FileSystem","copyAsync","from","to","cacheDirectory","Asset","fromURI","downloadAsync","vert","createShader","VERTEX_SHADER","frag","FRAGMENT_SHADER","shaderSource","compileShader","program","createProgram","attachShader","linkProgram","useProgram","buffer","createBuffer","bindBuffer","ARRAY_BUFFER","verts","Float32Array","bufferData","STATIC_DRAW","positionAttrib","getAttribLocation","enableVertexAttribArray","vertexAttribPointer","FLOAT","texture","createTexture","activeTexture","TEXTURE0","bindTexture","TEXTURE_2D","texParameteri","TEXTURE_MAG_FILTER","LINEAR","TEXTURE_MIN_FILTER","texImage2D","RGBA","UNSIGNED_BYTE","uniform1i","getUniformLocation","uniform1f","pixelFrequency","Math","max","round","catch","e","console","error","firstPassTexture","TEXTURE1","drawingBufferWidth","drawingBufferHeight","fb","createFramebuffer","bindFramebuffer","FRAMEBUFFER","attachmentPoint","COLOR_ATTACHMENT0","framebufferTexture2D","endFrameEXP","throttleSliderBlur","useRef","value","leading","current","styles","container","row","justifyContent","slider","sliderTrack","prompt","StyleSheet","create","flex","flexDirection","alignItems","color","fontSize","textAlign","paddingHorizontal","maxWidth","borderRadius"],"mappings":"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","sourcesContent":["import * as React from \"react\";\r\nimport { StyleSheet, View, Text, PixelRatio, Platform } from \"react-native\";\r\nimport { useRecoilState } from \"recoil\";\r\nimport { IconButton } from \"../components/IconButton\";\r\nimport {\r\n  editingModeState,\r\n  glContextState,\r\n  glProgramState,\r\n  imageBoundsState,\r\n  imageDataState,\r\n  processingState,\r\n} from \"../Store\";\r\nimport { Slider } from \"@miblanchard/react-native-slider\";\r\nimport { Asset } from \"expo-asset\";\r\nimport { GLView } from \"expo-gl\";\r\nimport * as ImageManinpulator from \"expo-image-manipulator\";\r\nimport * as FileSystem from \"expo-file-system\";\r\nimport _, { debounce, throttle } from \"lodash\";\r\nimport { EditorContext } from \"../index\";\r\n\r\nconst vertShader = `\r\nprecision highp float;\r\nattribute vec2 position;\r\nvarying vec2 uv;\r\nvoid main () {\r\n  uv = position;\r\n  gl_Position = vec4(1.0 - 2.0 * uv, 0, 1);\r\n}`;\r\n\r\nconst fragShader = `\r\nprecision highp float;\r\nprecision highp int;\r\nuniform sampler2D texture;\r\nuniform highp float width;\r\nuniform highp float height;\r\nvarying vec2 uv;\r\nuniform highp int radius;\r\nuniform highp int pass;\r\nuniform highp float pixelFrequency;\r\nfloat gauss (float sigma, float x) {\r\n  float g = (1.0/sqrt(2.0*3.142*sigma*sigma))*exp(-0.5*(x*x)/(sigma*sigma));\r\n  return g;\r\n}\r\nvoid main () {\r\n  float f_radius = float(radius);\r\n  float sigma = (0.5 * f_radius);\r\n  // Get the color of the fragment pixel\r\n  vec4 color = texture2D(texture, vec2(uv.x, uv.y));\r\n  color *= gauss(sigma, 0.0);\r\n  // Loop over the neightbouring pixels\r\n  for (int i = -30; i <= 30; i++) {\r\n    // Make sure we don't include the main pixel which we already sampled!\r\n    if (i != 0) {\r\n      // Check we are on an index that doesn't exceed the blur radius specified\r\n      if (i >= -radius && i <= radius) {\r\n        float index = float(i);\r\n        // Caclulate the current pixel index\r\n        float pixelIndex = 0.0;\r\n        if (pass == 0) {\r\n          pixelIndex = (uv.y) * height;\r\n        }\r\n        else {\r\n          pixelIndex = uv.x * width;\r\n        }\r\n        // Get the neighbouring pixel index\r\n        float offset = index * pixelFrequency;\r\n        pixelIndex += offset;\r\n        // Normalise the new index back into the 0.0 to 1.0 range\r\n        if (pass == 0) {\r\n          pixelIndex /= height;\r\n        }\r\n        else {\r\n          pixelIndex /= width;\r\n        }\r\n        // Pad the UV \r\n        if (pixelIndex < 0.0) {\r\n          pixelIndex = 0.0;\r\n        }\r\n        if (pixelIndex > 1.0) {\r\n          pixelIndex = 1.0;\r\n        }\r\n        // Get gaussian amplitude\r\n        float g = gauss(sigma, index);\r\n        // Get the color of neighbouring pixel\r\n        vec4 previousColor = vec4(0.0, 0.0, 0.0, 0.0);\r\n        if (pass == 0) {\r\n          previousColor = texture2D(texture, vec2(uv.x, pixelIndex)) * g;\r\n        }\r\n        else {\r\n          previousColor = texture2D(texture, vec2(pixelIndex, uv.y)) * g;\r\n        }\r\n        color += previousColor;\r\n      }\r\n    }\r\n  }\r\n  // Return the resulting color\r\n  gl_FragColor = color;\r\n}`;\r\n\r\nexport function Blur() {\r\n  //\r\n  const [, setProcessing] = useRecoilState(processingState);\r\n  const [imageData, setImageData] = useRecoilState(imageDataState);\r\n  const [, setEditingMode] = useRecoilState(editingModeState);\r\n  const [glContext, setGLContext] = useRecoilState(glContextState);\r\n  const [imageBounds] = useRecoilState(imageBoundsState);\r\n  const { throttleBlur } = React.useContext(EditorContext);\r\n\r\n  const [sliderValue, setSliderValue] = React.useState(15);\r\n  const [blur, setBlur] = React.useState(15);\r\n  const [glProgram, setGLProgram] = React.useState<WebGLProgram | null>(null);\r\n\r\n  const onClose = () => {\r\n    // If closing reset the image back to its original\r\n    setGLContext(null);\r\n    setEditingMode(\"operation-select\");\r\n  };\r\n\r\n  const onSaveWithBlur = async () => {\r\n    // Set the processing to true so no UI can be interacted with\r\n    setProcessing(true);\r\n    // Take a snapshot of the GLView's current framebuffer and set that as the new image data\r\n    const gl = glContext;\r\n    if (gl) {\r\n      gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n      const output = await GLView.takeSnapshotAsync(gl);\r\n      // Do any addtional platform processing of the result and set it as the\r\n      // new image data\r\n      if (Platform.OS === \"web\") {\r\n        const fileReaderInstance = new FileReader();\r\n        fileReaderInstance.readAsDataURL(output.uri as any);\r\n        fileReaderInstance.onload = async () => {\r\n          const base64data = fileReaderInstance.result;\r\n          const flippedOutput = await ImageManinpulator.manipulateAsync(\r\n            base64data as string,\r\n            [{ flip: ImageManinpulator.FlipType.Vertical }]\r\n          );\r\n          setImageData({\r\n            uri: flippedOutput.uri,\r\n            width: flippedOutput.width,\r\n            height: flippedOutput.height,\r\n          });\r\n        };\r\n      } else {\r\n        const flippedOutput = await ImageManinpulator.manipulateAsync(\r\n          output.uri as string,\r\n          [{ flip: ImageManinpulator.FlipType.Vertical }]\r\n        );\r\n        setImageData({\r\n          uri: flippedOutput.uri as string,\r\n          width: flippedOutput.width,\r\n          height: flippedOutput.height,\r\n        });\r\n      }\r\n\r\n      // Reset back to operation selection mode\r\n      setProcessing(false);\r\n      setGLContext(null);\r\n      // Small timeout so it can set processing state to flase BEFORE\r\n      // Blur component is unmounted...\r\n      setTimeout(() => {\r\n        setEditingMode(\"operation-select\");\r\n      }, 100);\r\n    }\r\n  };\r\n\r\n  React.useEffect(() => {\r\n    if (glContext !== null) {\r\n      const setupGL = async () => {\r\n        // Load in the asset and get its height and width\r\n        const gl = glContext;\r\n        // Do some magic instead of using asset.download async as this tries to\r\n        // redownload the file:// uri on android and iOS\r\n        let asset;\r\n        if (Platform.OS !== \"web\") {\r\n          asset = {\r\n            uri: imageData.uri,\r\n            localUri: imageData.uri,\r\n            height: imageData.height,\r\n            width: imageData.width,\r\n          };\r\n          await FileSystem.copyAsync({\r\n            from: asset.uri,\r\n            to: FileSystem.cacheDirectory + \"blur.jpg\",\r\n          });\r\n          asset.localUri = FileSystem.cacheDirectory + \"blur.jpg\";\r\n        } else {\r\n          asset = Asset.fromURI(imageData.uri);\r\n          await asset.downloadAsync();\r\n        }\r\n        if (asset.width && asset.height) {\r\n          // Setup the shaders for our GL context so it draws from texImage2D\r\n          const vert = gl.createShader(gl.VERTEX_SHADER);\r\n          const frag = gl.createShader(gl.FRAGMENT_SHADER);\r\n          if (vert && frag) {\r\n            // Set the source of the shaders and compile them\r\n            gl.shaderSource(vert, vertShader);\r\n            gl.compileShader(vert);\r\n            gl.shaderSource(frag, fragShader);\r\n            gl.compileShader(frag);\r\n            // Create a WebGL program so we can link the shaders together\r\n            const program = gl.createProgram();\r\n            if (program) {\r\n              // Attach both the vertex and frag shader to the program\r\n              gl.attachShader(program, vert);\r\n              gl.attachShader(program, frag);\r\n              // Link the program - ensures that vetex and frag shaders are compatible\r\n              // with each other\r\n              gl.linkProgram(program);\r\n              // Tell GL we ant to now use this program\r\n              gl.useProgram(program);\r\n              // Create a buffer on the GPU and assign its type as array buffer\r\n              const buffer = gl.createBuffer();\r\n              gl.bindBuffer(gl.ARRAY_BUFFER, buffer);\r\n              // Create the verticies for WebGL to form triangles on the screen\r\n              // using the vertex shader which forms a square or rectangle in this case\r\n              const verts = new Float32Array([\r\n                -1, -1, 1, -1, 1, 1, -1, -1, -1, 1, 1, 1,\r\n              ]);\r\n              // Actually pass the verticies into the buffer and tell WebGL this is static\r\n              // for optimisations\r\n              gl.bufferData(gl.ARRAY_BUFFER, verts, gl.STATIC_DRAW);\r\n              // Get the index in memory for the position attribute defined in the\r\n              // vertex shader\r\n              const positionAttrib = gl.getAttribLocation(program, \"position\");\r\n              gl.enableVertexAttribArray(positionAttrib); // Enable it i guess\r\n              // Tell the vertex shader how to process this attribute buffer\r\n              gl.vertexAttribPointer(positionAttrib, 2, gl.FLOAT, false, 0, 0);\r\n              // Fetch an expo asset which can passed in as the source for the\r\n              // texImage2D\r\n\r\n              // Create some space in memory for a texture\r\n              const texture = gl.createTexture();\r\n              // Set the active texture to the texture 0 binding (0-30)\r\n              gl.activeTexture(gl.TEXTURE0);\r\n              // Bind the texture to WebGL stating what type of texture it is\r\n              gl.bindTexture(gl.TEXTURE_2D, texture);\r\n              // Set some parameters for the texture\r\n              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n              gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n              // Then set the data of this texture using texImage2D\r\n              gl.texImage2D(\r\n                gl.TEXTURE_2D,\r\n                0,\r\n                gl.RGBA,\r\n                gl.RGBA,\r\n                gl.UNSIGNED_BYTE,\r\n                asset as any\r\n              );\r\n              // Set a bunch of uniforms we want to pass into our fragment shader\r\n              gl.uniform1i(gl.getUniformLocation(program, \"texture\"), 0);\r\n              gl.uniform1f(\r\n                gl.getUniformLocation(program, \"width\"),\r\n                asset.width\r\n              );\r\n              gl.uniform1f(\r\n                gl.getUniformLocation(program, \"height\"),\r\n                asset.height\r\n              );\r\n              // Calculate the pixel frequency to sample at based on the image resolution\r\n              // as the blur radius is in dp\r\n              const pixelFrequency = Math.max(\r\n                Math.round(imageData.width / imageBounds.width / 2),\r\n                1\r\n              );\r\n              gl.uniform1f(\r\n                gl.getUniformLocation(program, \"pixelFrequency\"),\r\n                pixelFrequency\r\n              );\r\n              setGLProgram(program);\r\n            }\r\n          }\r\n        }\r\n      };\r\n      setupGL().catch((e) => console.error(e));\r\n    }\r\n  }, [glContext, imageData]);\r\n\r\n  React.useEffect(() => {\r\n    const gl = glContext;\r\n    const program = glProgram;\r\n    if (gl !== null && program !== null) {\r\n      gl.uniform1i(gl.getUniformLocation(program, \"texture\"), 0);\r\n      gl.uniform1i(gl.getUniformLocation(program, \"radius\"), blur);\r\n      gl.uniform1i(gl.getUniformLocation(program, \"pass\"), 0);\r\n      // Setup so first pass renders to a texture rather than to canvas\r\n      // Create and bind the framebuffer\r\n      const firstPassTexture = gl.createTexture();\r\n      // Set the active texture to the texture 0 binding (0-30)\r\n      gl.activeTexture(gl.TEXTURE1);\r\n      // Bind the texture to WebGL stating what type of texture it is\r\n      gl.bindTexture(gl.TEXTURE_2D, firstPassTexture);\r\n      // Set some parameters for the texture\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n      // Then set the data of this texture using texImage2D\r\n      gl.texImage2D(\r\n        gl.TEXTURE_2D,\r\n        0,\r\n        gl.RGBA,\r\n        gl.drawingBufferWidth,\r\n        gl.drawingBufferHeight,\r\n        0,\r\n        gl.RGBA,\r\n        gl.UNSIGNED_BYTE,\r\n        null\r\n      );\r\n      const fb = gl.createFramebuffer();\r\n      gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\r\n      // attach the texture as the first color attachment\r\n      const attachmentPoint = gl.COLOR_ATTACHMENT0;\r\n      gl.framebufferTexture2D(\r\n        gl.FRAMEBUFFER,\r\n        attachmentPoint,\r\n        gl.TEXTURE_2D,\r\n        firstPassTexture,\r\n        0\r\n      );\r\n      //gl.viewport(0, 0, imageData.width, imageData.height);\r\n      // Actually draw using the shader program we setup!\r\n      gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n      gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n      //gl.viewport(0, 0, imageData.width, imageData.height);\r\n      gl.uniform1i(gl.getUniformLocation(program, \"texture\"), 1);\r\n      gl.uniform1i(gl.getUniformLocation(program, \"pass\"), 1);\r\n      gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n      gl.endFrameEXP();\r\n    }\r\n  }, [blur, glContext, glProgram]);\r\n\r\n  const throttleSliderBlur = React.useRef<(value: number) => void>(\r\n    throttle((value) => setBlur(value), 50, { leading: true })\r\n  ).current;\r\n\r\n  React.useEffect(() => {\r\n    return () => {};\r\n  });\r\n\r\n  if (glContext === null) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <View style={styles.container}>\r\n      <View style={[styles.row, { justifyContent: \"center\" }]}>\r\n        <Slider\r\n          value={sliderValue}\r\n          onValueChange={(value) => {\r\n            setSliderValue(value[0]);\r\n            if (throttleBlur) {\r\n              throttleSliderBlur(Math.round(value[0]));\r\n            } else {\r\n              setBlur(Math.round(value[0]));\r\n            }\r\n          }}\r\n          minimumValue={1}\r\n          maximumValue={30}\r\n          minimumTrackTintColor=\"#00A3FF\"\r\n          maximumTrackTintColor=\"#ccc\"\r\n          thumbTintColor=\"#c4c4c4\"\r\n          containerStyle={styles.slider}\r\n          trackStyle={styles.sliderTrack}\r\n        />\r\n      </View>\r\n      <View style={styles.row}>\r\n        <IconButton iconID=\"close\" text=\"Cancel\" onPress={() => onClose()} />\r\n        <Text style={styles.prompt}>\r\n          Blur Radius: {Math.round(sliderValue)}\r\n        </Text>\r\n        <IconButton\r\n          iconID=\"check\"\r\n          text=\"Done\"\r\n          onPress={() => onSaveWithBlur()}\r\n        />\r\n      </View>\r\n    </View>\r\n  );\r\n}\r\n\r\nconst styles = StyleSheet.create({\r\n  container: {\r\n    flex: 1,\r\n    flexDirection: \"column\",\r\n    justifyContent: \"space-between\",\r\n    alignItems: \"center\",\r\n  },\r\n  prompt: {\r\n    color: \"#fff\",\r\n    fontSize: 21,\r\n    textAlign: \"center\",\r\n  },\r\n  row: {\r\n    width: \"100%\",\r\n    height: 80,\r\n    flexDirection: \"row\",\r\n    justifyContent: \"space-between\",\r\n    alignItems: \"center\",\r\n    paddingHorizontal: \"2%\",\r\n  },\r\n  slider: {\r\n    height: 20,\r\n    width: \"90%\",\r\n    maxWidth: 600,\r\n  },\r\n  sliderTrack: {\r\n    borderRadius: 10,\r\n  },\r\n});\r\n"]}